# 二维水动力模拟系统 (2D Hydrodynamic Model) 功能说明书

## 1. 系统概述
本系统是一个基于 Web 的高性能水动力模拟平台，集成了地理信息系统（GIS）可视化、GPU 加速计算引擎和交互式参数配置功能。
系统支持 **纯二维 (2D Only)** 和 **一二维耦合 (Coupled 1D-2D)** 两种模拟模式，旨在为用户提供快速、直观的流域洪水与河道水流演进模拟工具。

## 2. 模拟模式与工作流 (Simulation Modes)

### 2.1 纯二维模式 (2D Only)
*   **适用场景**: 只有 DEM 数据，关注地表漫流、溃坝、城市内涝等不需要精细河道网络的情况。
*   **特点**: 计算速度极快，完全在 GPU 上运行。
*   **入口**: 默认界面为 "2D Hydro Model (GIS)"，或点击 "Load 2D Only (No 1D)" 按钮切换。

### 2.2 一二维耦合模式 (Coupled 1D-2D)
*   **适用场景**: 同时拥有 DEM 和河道断面数据，需要模拟河道洪水漫溢到两岸（漫堤）或从两岸回流进河道的过程。
*   **特点**: 
    *   河道使用一维圣维南方程求解（C++核心，速度快）。
    *   洪泛区使用二维浅水方程求解（GPU加速）。
    *   两者通过侧向连接（Lateral Coupling）进行实时的质量与动量交换。
*   **入口**: 点击界面左上角的 **"Switch to Coupled 1D-2D"** 按钮。

## 3. 核心功能与参数详解

### 3.1 地形数据管理 (Terrain Data)
*   **Load Test Terrain (加载测试地形)**
    *   **功能**: 加载系统内置的测试区域高程数据（类鄱阳湖区域），用于快速上手体验。
    *   **输入**: 无。
    *   **输出**: 自动初始化地图并缩放至测试区域，显示地形图层。
*   **Upload DEM (上传地形)**
    *   **功能**: 上传用户自定义的高程数据文件。
    *   **输入格式**: `.tif` 或 `.tiff` (GeoTIFF 格式)。
    *   **参数要求**: 
        *   必须包含地理坐标信息（Projection）。
        *   建议使用 **WGS84 (EPSG:4326)** 或 **Web Mercator (EPSG:3857)** 坐标系。
        *   **单位**: 高程值单位为 **米 (m)**。
    *   **处理机制**: 系统自动进行坐标重投影（至 EPSG:3857）、无效值（NoData）过滤和空洞填充。

### 3.2 交互式地图控制 (Interactive Map Controls)
*   **底图切换**: 系统集成了多种在线底图服务。用户可以通过地图右上角的图层控制器，在 **OpenStreetMap (标准电子地图)** 和 **Satellite Imagery (高清卫星影像)** 之间自由切换，以便结合地物纹理（如房屋、道路、植被）进行更直观的建模和分析。
*   **图层管理**: 所有的模拟结果图层（如水深、流场）、边界图层（Inflow/Outflow）均可通过图层控制器进行显隐控制。

### 3.3 边界条件与计算范围 (Tools & Boundaries)
本系统提供多种工具用于定义计算区域和水流边界。

#### 3.3.1 Draw Inflow (绘制入流边界)
*   **功能**: 在地图上绘制折线（Polyline），定义水流进入计算区域的位置。
*   **参数配置**:
    *   **Type (类型)**:
        *   **Water Level (H)**: **水位边界**。固定边界处的水位高程。
            *   **单位**: **米 (m)** (基于海平面的绝对高程，即 地形高度 + 水深)。
            *   **注意**: 输入值必须高于该处的地形高程，否则无水流入。
        *   **Flow Rate (Q)**: **流量边界**。指定边界处的入流流量。
            *   **单位**: **立方米每秒 (m³/s)**。
            *   **计算**: 系统会自动根据边界长度和网格大小，将流量转换为单宽流量或流速施加到网格单元上。
    *   **Mode (模式)**:
        *   **Constant (恒定)**: 模拟过程中数值保持不变。
            *   **输入**: 单个数值（如 `200.0`）。
        *   **Time Series (时间序列)**: 数值随模拟时间变化。
            *   **输入格式**: CSV 格式文本（时间, 数值）。
            *   **示例**:
                ```csv
                0, 100   (第0秒，流量100)
                1800, 200 (第1800秒，流量200)
                3600, 150 (第3600秒，流量150)
                ```
            *   **插值**: 系统会在时间点之间进行线性插值。

#### 3.3.2 Draw Outflow (绘制出流边界)
*   **功能**: 在地图上绘制折线（Polyline），定义水流流出的位置。
*   **机制**: **透射边界 (Transmissive / Zero-Gradient)**。假设边界处水位和流速梯度为零，允许水流自由流出计算域，不产生回水影响。
*   **输入**: 仅需绘制位置，无额外参数。

#### 3.3.3 Draw Mask (绘制掩膜/障碍物)
*   **功能**: 在地图上绘制多边形（Polygon），定义**不参与计算**的区域。
*   **应用**: 建筑物、岛屿、堤坝等不透水区域。
*   **效果**: 该区域内的网格单元将被标记为“非活动（Inactive）”，水流无法进入。系统已针对此类边界进行了**内部墙边界 (Internal Wall)** 优化，确保即使在复杂形状下也能保持数值稳定和水量守恒。

#### 3.3.4 Draw AOI (绘制感兴趣区域)
*   **功能**: 在地图上绘制多边形（Polygon），定义**有效计算区域 (Area of Interest)**。
*   **机制**: **反向掩膜**。只有绘制的多边形**内部**区域参与计算，多边形**外部**的所有区域都将被强制关闭（设为 Inactive）。
*   **应用**: 当 DEM 范围很大，但只想模拟其中一小块流域时使用，可显著减少计算量。

#### 3.3.5 Draw 1D Channel (绘制一维河道) [仅耦合模式]
*   **功能**: 在地图上交互式绘制一维河网。
*   **操作**:
    *   左键点击添加节点，双击结束一条河段（Branch）。
    *   新河段的起点或终点如果靠近已有节点，会自动吸附（Snap），形成河网节点（Junction）。
*   **几何完整性检查 (New)**:
    *   **Ghost Water 防护**: 系统会自动检测绘制的河道与节点位置是否偏移。如果偏差过大（>50米），控制台会输出警告。
    *   **重叠检测**: 如果两条河道在空间上交叉（或重叠）但在拓扑上没有连接节点，系统会发出警告。这种情况会导致水流“瞬移”产生幽灵水流，请务必避免。
    *   **真实长度**: 系统使用折线的实际曲线长度计算河道物理长度，而非简单的直线距离。
*   **参数**:
    *   **Width Start/End**: 河宽（米）。
    *   **Z Start/End**: 河底高程（米）。
    *   **Manning's n**: 曼宁糙率。
    *   **dx**: 断面间距（米）。
*   **初始化**: 可以设置初始水深。
*   **耦合**: 绘制的河道会自动与底层的二维网格建立耦合关系。

#### 3.3.6 Upload Boundary (上传边界文件)
*   **功能**: 上传外部 GIS 文件批量设置边界。
*   **支持格式**: `.zip` (包含 Shapefile 的压缩包) 或 `.geojson` / `.json`。
*   **属性映射**:
    *   系统会尝试读取文件中的 `value` 字段作为边界值。
    *   文件中的几何体将被应用为 Mask（默认）。

### 3.4 模拟参数配置 (Simulation Settings)
*   **Total Time (s)**: 模拟总时长。
*   **Output Interval (s)**: 结果保存间隔。
*   **Coupling Cd**: 耦合流量系数 (0.0~2.0)，控制河道与洪泛区交换效率。
*   **Coupling Method**: 
    *   **Empirical**: 经验公式法（快）。
    *   **Numerical Flux**: 数值通量法（准）。
*   **Bank Height**: 河岸高度（相对地形），用于判断是否漫堤。

### 3.5 视图控制 (View Control)
*   **视角操作**: 支持平移（左键拖拽）、缩放（滚轮）、旋转（右键拖拽）操作。
*   **复位功能**: 一键复位至初始视角，防止视图迷失。

### 3.6 一维河网模型 (1D River Network Model)
*   **核心算法**: 采用基于圣维南方程组（Saint-Venant Equations）的隐式有限差分法（Preissmann Scheme）。
*   **河网解法**: 实现了“分级联解法”（Hierarchical Solution），通过汊点水位迭代与河段内部的双扫描（Double Sweep）算法，有效解决复杂河网（环状、树状）的水动力计算问题。
*   **关键特性**:
    *   **窄缝法（Narrow Slot Method）**: 自动处理枯水期河道断流问题，保证计算稳定性。
    *   **结构化设计**: 支持任意拓扑结构的河网定义（River Reaches & Junctions）。
    *   **高精度**: 采用四点偏心隐式格式，在时间和空间上具有二阶精度。

## 4. 结果回放系统 (Playback Results)
模拟完成后（或进行中），可以使用回放功能详细分析过程。

### 4.1 核心控件
*   **Load/Refresh Results**: 拉取最新结果。
*   **Play / Pause**: 自动播放。
*   **Slider**: 拖动查看特定帧。
*   **Speed**: 控制播放速度 (ms/frame)。

### 4.2 独立图层控制
*   **Show Water (Playback)**: 专门控制回放时的水深显示，与实时显示互不冲突。

## 5. 模型原理详解 (Model Details)

### 5.1 二维水动力模型 (2D Hydrodynamic Model)
*   **控制方程**: 完整浅水方程组 (SWE)。
*   **数值方法**: 上帝位有限体积法 (Godunov-type FVM)。
*   **关键特性**:
    *   **Well-Balanced (和谐性)**: 引入底坡源项修正，彻底解决了"静水往山上跑"的问题，能在陡坡上维持静水表面水平。
    *   **Internal Wall (内部墙)**: 针对干湿边界和岛屿边界进行了特殊处理，通过施加静水压力边界条件，防止了不规则边界处的数值崩溃。
    *   **GPU 加速**: Taichi 驱动，支持数百万网格的实时计算。

### 5.2 一维水动力模型 (1D Hydrodynamic Model)
*   **控制方程**: 圣维南方程组。
*   **数值方法**: 有限体积法 + HLL 通量。
*   **实现**: C++ 编写的高性能核心库 (`swe_1d_core.dll`)。

### 5.3 一二维耦合机制 (1D-2D Coupling)
*   **侧向连接**: 河道作为二维网格的内部边界。
*   **交互**: 
    *   **河道 -> 洪泛区**: 当河道水位高于河岸且高于洪泛区水位时，水流溢出。
    *   **洪泛区 -> 河道**: 当洪泛区水位高于河岸且高于河道水位时，水流回流。

## 6. 技术规格
*   **计算后端**:
    *   **GPU**: NVIDIA CUDA / Vulkan (Taichi)。
    *   **CPU**: C++ (OpenMP)。
*   **前端**: Leaflet (地图), Chart.js (图表), WebSocket (实时通信)。
*   **坐标系**: 内部计算使用投影坐标 (米)，前端展示使用 Web Mercator (EPSG:3857)。
