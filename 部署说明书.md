# 系统部署与安装说明书

本说明书指导您如何在新的 Windows 设备上安装并运行二维水动力模拟系统。

## 1. 环境要求 (Prerequisites)

在安装之前，请确保目标计算机满足以下条件：

*   **操作系统**: Windows 10 或 Windows 11 (64位)。
*   **Python 环境**: Python 3.8 或更高版本 (推荐 **3.12**)。
*   **C++ 编译环境**: 
    *   必须安装 **Microsoft Visual Studio 2019** 或 **2022** (社区版即可)。
    *   安装时需勾选 **"使用 C++ 的桌面开发" (Desktop development with C++)** 工作负载。
    *   用于编译一维核心计算模块 (`swe_1d_core.dll`) 和耦合模块 (`swe_coupling.dll`)。
*   **GPU 驱动 (强烈推荐)**:
    *   如果设备有 NVIDIA 显卡，请更新至最新的驱动程序，并安装 CUDA Toolkit (推荐 11.x 或 12.x)。
    *   系统基于 **Taichi** 语言开发，支持 CUDA (NVIDIA)、Vulkan (通用) 和 CPU 后端。使用 GPU 可获得 50-100 倍的加速比。

## 2. 安装步骤 (Installation Steps)

### 第一步：获取代码
将本项目的完整文件夹复制到目标计算机的任意位置（例如 `D:\2Dpower`）。注意路径中**不要包含中文或空格**，以免引发兼容性问题。

### 第二步：一键安装
在文件夹中找到并双击运行 **`setup.bat`** 脚本。该脚本会自动执行以下操作：
1.  检查 Python 环境。
2.  安装所需的 Python 依赖库 (通过 `requirements.txt`)，核心库包括 `taichi`, `rasterio`, `fastapi`, `numpy` 等。
3.  调用 C++ 编译器自动编译核心算法库 (`swe_1d_core.dll`, `swe_coupling.dll` 等)。

**注意**:
*   如果脚本提示 `cl` 命令未找到或编译失败，请检查 `build.bat` 文件，确认 `VsDevCmd.bat` 的路径是否与您电脑上 Visual Studio 的安装路径一致。如果不一致，请右键编辑 `build.bat` 进行修改。
    *   *常见路径示例*: `C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\VsDevCmd.bat`

### 第三步：手动安装依赖 (如果脚本失败)
如果 `setup.bat` 中的 pip 安装失败（常见于 `rasterio` 库），请尝试手动安装：

1.  打开命令提示符 (CMD)，进入项目目录。
2.  运行: `pip install -r requirements.txt`
3.  如果 `rasterio` 报错，建议使用 Conda 安装: `conda install rasterio`，或者从 [Gohlke Wheels](https://www.lfd.uci.edu/~gohlke/pythonlibs/) 下载对应的 `.whl` 文件进行安装。

## 3. 运行系统 (Running)

安装完成后，双击运行 **`run_server.bat`**。

*   看到终端显示 `Uvicorn running on http://127.0.0.1:8003` 即表示启动成功。
*   打开浏览器（推荐 Chrome 或 Edge），访问 `http://127.0.0.1:8003` 即可使用系统。

## 4. 常见问题排查 (Troubleshooting)

### Q1: 启动时提示 `ModuleNotFoundError`
*   **原因**: 依赖库未安装完整。
*   **解决**: 重新运行 `pip install -r requirements.txt`，检查报错信息。

### Q2: 提示 `DLL load failed` 或找不到 `swe_1d_core.dll`
*   **原因**: C++ 核心文件未编译，或缺少 VC++ 运行库。
*   **解决**: 
    1. 确保已安装 Visual Studio C++ 开发组件。
    2. 运行 `build.bat` 重新编译。
    3. 如果是在没有 VS 的机器上直接运行（不编译），请确保安装了 [Visual C++ Redistributable](https://learn.microsoft.com/en-us/cpp/windows/latest-supported-vc-redist)。

### Q3: 网页地图不显示或操作无反应
*   **原因**: 可能是浏览器缓存或端口冲突。
*   **解决**: 
    1. 按 F12 打开开发者工具，查看 Console 是否有红色报错。
    2. 尝试更换端口：编辑 `web/server.py` 文件底部的 `port=8003` 为其他端口（如 8005）。

### Q4: 模拟速度非常慢
*   **原因**: 未启用 GPU 加速，正在使用 CPU 模式。
*   **解决**: 检查终端日志开头是否有 `[Taichi] Starting on arch=cuda` 或 `arch=vulkan`。如果是 `arch=cpu`，请检查显卡驱动是否正确安装。可以在 `swe_gpu.py` 中强制指定后端尝试修复。

### Q5: 计算结果为0或水往山上跑
*   **原因**: 早期版本的边界处理问题。
*   **解决**: 确保使用的是最新版本代码（已修复静水假定和内部墙边界问题）。
