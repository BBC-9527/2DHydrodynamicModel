# 二维水动力模型 - 项目结构说明文档

本文档旨在解释本仓库中关键文件的结构和用途。该项目实现了一个耦合的 1D-2D 水动力模型（类似简化的 HEC-RAS），并提供了 Web 界面和桌面 GUI 两种操作方式。

## 1. 核心仿真逻辑 (C++ / 后端)

为了保证性能，核心数值求解器采用 C++ 实现，并提供了 Python 封装以便集成。

*   **`src/swe_core.cpp`**:
    *   **用途**: 二维浅水方程 (SWE) 的 C++ 实现。
    *   **方法**: 有限体积法 (通常使用 HLL 通量)。
    *   **功能**: 处理二维网格状态（水深 `h`，流速 `u, v`，高程 `z`），边界条件（入流、出流、固壁）以及源项。
    *   **输出**: 编译为 `swe_core.dll`。

*   **`src/swe_1d_core.cpp`**:
    *   **用途**: 一维浅水方程的 C++ 实现。
    *   **功能**: 模拟具有变宽度的 1D 河道中的流动。处理边界条件（固定水深、流量、开口）和侧向入流。
    *   **输出**: 编译为 `swe_1d_core.dll`。

## 2. Python 封装与求解器

这些文件连接了 C++ 核心与上层应用逻辑。

*   **`swe_1d.py`**:
    *   **用途**: `swe_1d_core.dll` 的 Python 封装。
    *   **`SWEModel1D` 类**: 提供初始化 1D 模型、设置边界条件、应用源项以及推进仿真时间步的方法。

*   **`gui/swe_wrapper.py`**:
    *   **用途**: 二维 `swe_core.dll` 的 Python 封装，主要供桌面 GUI 使用。
    *   **`SWEModel` 类**: 处理 2D C++ 求解器的初始化、边界掩码设置和结果检索。

*   **`swe_gpu.py`**:
    *   **用途**: 使用 **Taichi** 实现的替代性 2D SWE 求解器，支持 GPU 加速。
    *   **功能**: 专为高性能 2D 仿真设计，在可用 GPU 的场景下可替代 C++ 核心。

*   **`coupler.py`**:
    *   **用途**: 实现 **1D-2D 耦合** 逻辑。
    *   **功能**:
        *   定义 `CouplingNode` 来表示 1D 河道单元与 2D 网格单元之间的连接（堰或孔口）。
        *   根据水位差计算交换流量 (`compute_exchange`)，并将其作为源项添加到相应的模型中。

## 3. Web 界面 (`web/`)

用于运行仿真和可视化结果的基于浏览器的界面。

*   **`web/server.py`**:
    *   **用途**: **FastAPI** 后端服务器。
    *   **主要职责**:
        *   提供静态前端页面。
        *   **项目管理**: 加载 DEM 文件，初始化仿真状态。
        *   **仿真控制**: 提供开始、停止和单步执行仿真的接口。
        *   **数据可视化**: 生成并向前端提供可视化切片/图像（地形、水深）。包含动态视口渲染逻辑。
    *   **依赖**: 使用 `rasterio` 处理 GIS 数据，`pyproj` 进行坐标转换，`PIL` 生成图像。

*   **`web/static/index.html`**:
    *   **用途**: 前端客户端。
    *   **技术栈**: HTML/JS 配合 **Leaflet.js** 用于地图展示。
    *   **功能**: 用于查看地形和仿真结果的交互式地图，仿真控制按钮（开始、暂停、重置）以及参数输入。

## 4. 桌面 GUI (`gui/`)

该模型的独立桌面应用程序。

*   **`gui/main_app.py`**:
    *   **用途**: **PyQt5** 应用程序的主入口点。
    *   **功能**:
        *   **DEM 加载**: 加载 GeoTIFF 高程模型。
        *   **边界定义**: 使用 `matplotlib` 组件直接在地图上绘制入流、出流和非活动掩码区域。
        *   **可视化**: 实时绘制仿真结果。

## 5. 构建与实用脚本

*   **`build.bat`**: Windows 批处理脚本，用于将 C++ 源文件 (`src/*.cpp`) 编译为 DLL (`*.dll`)。
*   **`check_gpu.py`**: 用于验证 GPU 是否可用且能被 Taichi 访问的实用工具。
*   **`requirements.txt`**: Python 依赖列表（例如 `numpy`, `rasterio`, `fastapi`, `taichi`, `pyqt5`）。

## 数据流摘要

1.  **输入**: 用户加载 DEM (GeoTIFF)。
2.  **初始化**:
    *   **Web**: `server.py` 使用 `rasterio` 读取 DEM，初始化 `SWEModelGPU` (或 C++ 核心)，并在配置时准备 1D 模型。
    *   **桌面**: `main_app.py` 加载 DEM 并初始化 `SWEModel` (C++ 封装)。
3.  **仿真循环**:
    *   `Coupler` 计算 1D 和 2D 域之间的流量。
    *   1D 和 2D 求解器 (`swe_1d.py`, `swe_gpu.py`/`swe_core.dll`) 推进一个时间步。
4.  **可视化**:
    *   **Web**: 前端向 `server.py` 请求图像叠加层，后端渲染当前状态（水深 + 地形）。
    *   **桌面**: Matplotlib 画布根据新的水深数组进行更新。
